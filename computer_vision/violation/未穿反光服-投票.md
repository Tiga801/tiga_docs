# 未穿反光服检测任务判定逻辑说明

## 背景
实现一个基于视频流的未穿反光服（vest）检测任务。在实时视频中对人员进行检测、跟踪与属性判定，并在满足违规条件时发送告警消息。由于反光服分类模型在单帧上的稳定性有限，若直接基于单帧结果进行判定，容易产生误报或类别抖动问题，因此需要设计一套稳定、可解释、工程可落地的判定逻辑。

## 目标
- 在视频流中稳定、准确地识别**未穿反光服的人员**
- 降低因模型不稳定、单帧误判带来的误报率
- 确保告警触发逻辑具备时序一致性和可解释性
- 支持在 ROI 场景下的定点监管需求
- 判定逻辑可复用、可调参、易于维护

## 约束
- 不允许仅基于单帧分类结果直接触发告警
- 不允许对 ROI 区域外的目标进行违规判定
- 必须基于目标跟踪（Track ID）进行时序判定
- 告警策略需具备参数化能力（阈值、窗口大小等）
- 未穿反光服属于高风险负类，判定策略应保守：宁可慢判不可错判，宁可不报不可乱报

## 输出要求
- 清晰说明整体处理流程与各阶段逻辑
- 明确未穿反光服违规的最终判定条件
- 给出基于 Track ID 的历史投票判定机制
- 提出有助于提升稳定性和工程效果的合理建议

---

## 任务判定流程说明

### 1. 人员目标检测
- 对视频流中的每一帧执行 YOLO 目标检测
- 从检测结果中筛选出 `person` 类别的目标
- 获取每个目标的：
  - Bounding Box（x1, y1, x2, y2）
  - 置信度 score

### 2. 置信度与 ROI 区域过滤
- 若人员检测置信度低于设定阈值，则忽略该目标
- 对满足置信度要求的目标，判断其中心点是否位于预先配置的 ROI 区域内
- 若目标的检测框中心点不在任何 ROI 区域内，则不进入后续逻辑

### 3. 人员目标跟踪
- 对通过 ROI 校验的人员目标进行多目标跟踪
- 为每个目标分配唯一的 `track_id`
- 后续所有判定逻辑均以 `track_id` 作为时序关联的唯一标识

### 4. 有效帧过滤与反光服分类

#### 4.1 有效帧判定
不是所有帧都应该进入分类流程，以下情况应丢弃分类结果：
- bbox 面积 < 最小阈值

#### 4.2 反光服分类
- 根据检测到的 bounding box，从原始帧中裁剪人员 ROI 图像
- 将裁剪后的图像输入反光服分类模型进行推理
- 分类模型输出目标是否属于 `vest` 类（穿反光服 `vest` / 未穿反光服 `non-vest`）

### 5. 基于 Track ID 的判定机制

#### 5.1 历史投票法

```
数据结构:
{
  track_id_1: [vest, vest, non-vest, vest, ...],  # 类别历史队列
  track_id_2: [non-vest, non-vest, non-vest, ...],
  ...
}
```

为提高稳定性，引入"历史投票法"进行最终类别判定：

- 对每个 `track_id` 维护一个 **类别历史队列**
  - 队列中存储该目标在最近若干帧中的分类结果（vest / non-vest）
  - 队列长度为 N（可配置）

- 每当获得新的分类结果时：
  - 将结果加入对应 `track_id` 的类别历史队列
  - 若队列长度超过 N，则移除最早的记录

- 判定逻辑：
  - 当某个 `track_id` 的类别历史队列中，被判定为 **non-vest 类** 的次数超过设定阈值
  - 该目标的最终类别取 **最近 N 帧中的多数投票结果**
  - 若多数投票结果为非 vest，则认为该目标当前处于违规状态

### 6. 告警触发
- 当目标被稳定判定为未穿反光服，且满足持续帧数 / 时间阈值要求时
- 发送未穿反光服违规告警消息
- 同一 `track_id` 可设置告警冷却时间，避免重复告警

---

## 合理建议

1. **历史窗口与阈值解耦**
   - 投票窗口大小 N 与违规触发阈值应独立配置，便于不同场景调优

2. **引入"状态确认帧"机制**
   - 在目标刚出现的前若干帧内不参与违规判定，减少初始误判
   - 推荐：`min_confirm = 5~10`

3. **结合目标可见性条件**
   - 对遮挡严重、ROI 面积过小的目标可暂缓分类判定
   - 建议设置最小 bbox 面积阈值和人体高度比例阈值

4. **支持动态参数调整**
   - 针对不同摄像头、光照条件，支持在线调整目标检测、图像分类得分阈值参数

5. **告警与判定解耦**
   - 判定逻辑只负责输出"是否违规"
   - 告警模块单独处理告警频率、合并策略与消息发送

---

## 总结
通过“目标检测 + ROI 过滤 + 目标跟踪 + 分类模型 + 基于 Track ID 的历史投票法”，该未穿反光服检测逻辑能够有效抑制模型抖动带来的误判问题，在保证实时性的同时显著提升整体系统的稳定性与工程可靠性。

---

## 违规检测关键参数配置示例

```python
CONFIG = {
    # 检测参数
    "detect_conf": 0.6,           # YOLO 检测置信度阈值
    "nms_iou": 0.45,              # NMS IoU 阈值

    # 跟踪参数
    "max_age": 30,                # 跟踪目标最大丢失帧数
    "min_hits": 3,                # 最小连续检测帧数
    "min_confirm": 5,             # Track 稳定确认帧数
    "max_missing": 3,             # Track 丢失容忍帧数

    # 有效帧过滤参数
    "min_bbox_area": 1000,        # 最小 bbox 面积

    # 分类参数
    "classify_conf": 0.7,         # 分类置信度阈值
    "history_queue": 20,          # 历史队列长度
    "vio_threshold": 14,          # 违规判定阈值(次数)

    # 告警参数
    "cooldown_period": 60,        # 告警冷却时间(秒)
}
```
