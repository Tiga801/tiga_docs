# 人脸检测任务判定逻辑说明

## 背景
实现一个基于视频流的人脸检测与抓拍任务。在实时视频中对人员进行检测、跟踪与人脸抓拍，并将高质量的人脸图像上传存储。由于视频流中人员姿态多变、遮挡频繁，若直接基于单帧结果进行抓拍，容易产生大量低质量图像或重复抓拍问题，因此需要设计一套稳定、高质量、工程可落地的判定逻辑。

## 目标
- 在视频流中稳定、准确地**抓拍高质量人脸图像**
- 降低因姿态不佳、遮挡严重带来的低质量抓拍
- 确保同一目标在轨迹生命周期内输出**最优质量的人脸**
- 支持在 ROI 场景下的定点监控需求
- 判定逻辑可复用、可调参、易于维护

## 约束
- 不允许仅基于单帧人脸检测结果直接触发抓拍
- 不允许对 ROI 区域外的目标进行人脸抓拍
- 必须基于目标跟踪（Track ID）进行时序判定
- 抓拍策略需具备参数化能力（阈值、质量评分等）
- 人脸抓拍需保证高质量：宁可少拍不可乱拍，宁可漏拍不可拍差

## 输出要求
- 清晰说明整体处理流程与各阶段逻辑
- 明确人脸抓拍的最终触发条件
- 给出基于 Track ID 的时序质量优选机制
- 提出有助于提升抓拍质量和工程效果的合理建议

---

## 任务判定流程说明

### 1. 人员目标检测
- 对视频流中的每一帧执行 YOLO Pose 目标检测
- 从检测结果中筛选出 `person` 类别的目标
- 获取每个目标的：
  - Bounding Box（x1, y1, x2, y2）
  - 置信度 score
  - 关键点信息（17个人体关键点及其置信度）

### 2. ROI 区域过滤
- 对检测到的人员目标，判断其中心点是否位于预先配置的 ROI 区域内
- 若目标的检测框中心点不在任何 ROI 区域内，则不进入后续逻辑
- ROI 过滤在跟踪之后、质量判定之前执行

### 3. 人员目标跟踪
- 对通过检测的人员目标进行多目标跟踪（BYTETracker）
- 为每个目标分配唯一的 `track_id`
- 后续所有判定逻辑均以 `track_id` 作为时序关联的唯一标识

### 4. 五步判定逻辑

为保证抓拍的人脸图像质量，采用"五步判定法"进行最终抓拍触发：

```
数据结构:
{
  track_id_1: {"max_kpt_sum": float, "max_face_score": float},
  track_id_2: {"max_kpt_sum": float, "max_face_score": float},
  ...
}
```

#### Step 1: 关键点绝对阈值检查
- 计算人体前5个关键点（鼻子、双眼、双耳）的置信度之和 `kpt_sum`
- 判断条件：`kpt_sum >= 5 * kpt_score_threshold`
- 目的：确保人员正面朝向摄像头，面部关键点清晰可见
- 若不满足，跳过当前目标

#### Step 2: 关键点时序优选检查
- 判断条件：`kpt_sum > max_kpt_sum + 0.1`
- 目的：确保当前帧的人体姿态优于历史最佳
- 若满足，更新 `max_kpt_sum`；否则跳过当前目标

#### Step 3: 人脸检测
- 仅当 Step 1 & Step 2 通过后执行
- 根据人体检测框裁剪人员 ROI 图像
- 使用 InsightFace 进行人脸检测
- 若检测到多张人脸，选择检测置信度最高的作为目标人脸

#### Step 4: 人脸置信度绝对阈值检查
- 判断条件：`face_score >= face_score_threshold`
- 目的：确保检测到的人脸质量达到基本要求
- 若不满足，跳过当前目标

#### Step 5: 人脸置信度时序优选检查
- 判断条件：`face_score > max_face_score + 0.1`
- 目的：确保当前帧的人脸质量优于历史最佳
- 若满足，更新 `max_face_score` 并触发抓拍；否则跳过当前目标

### 5. 抓拍输出
- 当目标通过全部五步判定后触发抓拍
- 输出内容：
  - 人体图像（body image）
  - 人脸图像（face image）
  - 扩展人脸图像（expanded face image）
  - 可视化标注图像（visual image）
  - 人脸特征向量（embedding）
  - 人脸属性（性别、年龄等）
- 图像上传至 MinIO 对象存储
- 通过 MQTT 发送抓拍消息

### 6. 轨迹清理
- 定期清理已丢失轨迹的状态数据
- 避免内存泄漏

---

## 合理建议

1. **关键点与人脸双重校验**
   - 关键点置信度反映人体姿态，人脸置信度反映人脸质量
   - 两者结合可有效过滤侧身、低头、遮挡等低质量场景

2. **时序优选机制**
   - 通过历史最佳记录，确保每个轨迹只在质量提升时触发抓拍
   - 避免对同一目标重复抓拍低质量图像

3. **增量阈值设计（+0.1）**
   - 防止微小波动触发抓拍
   - 确保新抓拍的质量有显著提升

4. **ROI 区域前置过滤**
   - 减少无效计算，提升系统性能
   - 聚焦关键监控区域

5. **支持动态参数调整**
   - 针对不同摄像头、光照条件，支持在线调整关键点、人脸检测得分阈值参数

6. **帧跳过机制**
   - 支持配置 `frame_skip` 参数，降低计算负载
   - 在保证抓拍质量的前提下提升处理效率

---

## 总结
通过"人员检测 + 目标跟踪 + ROI 过滤 + 五步判定法"，该人脸检测抓拍逻辑能够有效抑制低质量抓拍问题，在保证实时性的同时显著提升抓拍图像的质量与系统的工程可靠性。核心思想是：**以关键点置信度评估姿态、以人脸置信度评估质量、以时序优选机制保证最优输出**。

---

## 关键参数配置示例

```python
CONFIG = {
    # 检测参数
    "model_path": "weights/yolov8m-pose.pt",   # Pose 模型路径
    "device": "cuda",                          # 推理设备
    "confidence": 0.5,                         # YOLO 检测置信度阈值
    "iou": 0.45,                               # NMS IoU 阈值

    # 跟踪参数
    "frame_rate": 30,                          # 视频帧率

    # 关键点判定参数
    "kpt_score": 0.9,                          # 单个关键点置信度阈值
    "kpt_max_score": 0.95,                     # 关键点最大置信度阈值

    # 人脸判定参数
    "face_score": 0.9,                         # 人脸检测置信度阈值
    "face_max_score": 0.95,                    # 人脸最大置信度阈值

    # 性能参数
    "frame_skip": 1,                           # 帧跳过间隔
}
```

## 判定流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                        视频帧输入                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    YOLO Pose 人员检测                            │
│              提取 bbox + 17个关键点置信度                          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BYTETracker 多目标跟踪                         │
│                    分配唯一 track_id                             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      ROI 区域过滤                                │
│                中心点不在 ROI 内则跳过                             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              Step 1: 关键点绝对阈值检查                            │
│              kpt_sum >= 5 × kpt_score_threshold                 │
└─────────────────────────────────────────────────────────────────┘
                                │ 通过
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              Step 2: 关键点时序优选检查                            │
│                 kpt_sum > max_kpt_sum + 0.1                     │
└─────────────────────────────────────────────────────────────────┘
                                │ 通过
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              Step 3: InsightFace 人脸检测                        │
│               裁剪人体区域 → 检测人脸                              │
└─────────────────────────────────────────────────────────────────┘
                                │ 检测到人脸
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              Step 4: 人脸置信度绝对阈值检查                         │
│              face_score >= face_score_threshold                 │
└─────────────────────────────────────────────────────────────────┘
                                │ 通过
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              Step 5: 人脸置信度时序优选检查                         │
│               face_score > max_face_score + 0.1                 │
└─────────────────────────────────────────────────────────────────┘
                                │ 通过
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      触发抓拍输出                                 │
│     上传图像至 MinIO + 发送 MQTT 消息 + 更新轨迹状态                 │
└─────────────────────────────────────────────────────────────────┘
```
